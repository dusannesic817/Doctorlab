{% extends "_global/index.html" %}


{% block main %}

<div class="container">
  <div class="row mt-3">
    <div class="col-12">
      <div class="text-center">
        Welcome to Doctorlab Virtual assistent.
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-10 col-md-8 col-lg-10 mx-auto d-flex flex-column" style="height: 75vh;">

      <div class="card flex-grow-1 mb-3" style="height: 75vh;">
        <div class="card-body d-flex flex-column-reverse overflow-auto" style="height: 100%;">
          <!-- poruke -->
          {% if userPrompt %}
          <div class="d-flex justify-content-end align-items-center mt-2">
            <span class="d-inline p-2 text-bg-primary rounded">{{ userPrompt }}</span>
            <img src="{{base_url}}/assets/images/undraw_profile.svg" alt="Avatar" class="rounded-circle ms-2 img-fluid"
              style="width: 40px; height: 40px;">
          </div>
          {% endif %}

          {% if gptResponse %}
          <div class="d-flex justify-content-start align-items-center mt-2">
            <img src="{{base_url}}/assets/images/doctor.jpg" alt="Avatar" class="rounded-circle me-2 img-fluid"
              style="width: 40px; height: 40px;">
            <span class="d-inline p-2 text-bg-info rounded text-white">{{ gptResponse }}</span>
          </div>
          {% endif %}

        </div>
      </div>
      <form method="POST" url="{{base_url}}/assistent">
        <div class="input-group">
          <input type="text" class="form-control" name="prompt" placeholder="Provide us your problem" aria-label="Problem" required>
          <button class="btn btn-primary" type="submit">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </form>

    </div>
  </div>
</div>


<script>
  // Omogući logovanje u konzolu radi debugovanja
  Pusher.logToConsole = true;

  // Inicijalizuj Pusher
  var pusher = new Pusher('6d7d51c13b5451452dd9', {
    cluster: 'eu'
  });

  // Pretplati se na kanal
  var channel = pusher.subscribe('my-channel');

  // Slušaj događaj 'gpt'
  channel.bind('gpt', function(data) {
    console.log('Primljena poruka od servera:', data);

    if (data.message) {
      const container = document.createElement('div');
      container.className = 'alert alert-info mt-2';
      container.innerText = 'GPT odgovor: ' + data.message;

      // Dodaj poruku na vrh stranice
      document.body.prepend(container);
    }
  });

  // === Test prikaz bez Pusher servera ===
  // Ako hoćeš samo da vidiš kako izgleda u DOM-u:
  /*
  document.addEventListener("DOMContentLoaded", function () {
    const testData = { message: 'Ovo je lokalna test poruka bez Pusher-a' };
    const container = document.createElement('div');
    container.className = 'alert alert-warning mt-2';
    container.innerText = 'GPT odgovor: ' + testData.message;
    document.body.prepend(container);
  });
  */
</script>


{%endblock%}